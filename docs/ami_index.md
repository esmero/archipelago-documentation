# Archipelago Multi-Importer (AMI)

[Archipelago Multi-Importer (AMI)](https://github.com/esmero/ami) is a module for batch/bulk/mass ingests of Archipelago digital objects (ADOs) and collections. AMI also enables you to perform batch administrative actions, such as updating, patching/revising, or deleting digital objects and collections.

#### *Work-in-Progress Notes*

*Please be aware that the version of AMI shipped with Archipelago 1.0.0-RC2 provides much of the core batch functions useful for getting started working with large amounts of content, but is not the full or final version of this module. This documentation page will be updated with successive AMI and Archipelago releases.*

## AMI Overview and Pre-Release Notes - AMI 0.1.0 (Archipelago - 1.0.0-RC2)

*From the desk of [Diego Pino](https://github.com/DiegoPino)*

AMI provides Tabulated data ingest for ADOs with customizable input plugins. Each Spreadsheet (or Google Spreadsheet) goes through a Configuration Multi Step setup and generates at the end an AMI Set. AMI Sets then can be enqueued or directly ingested, its generated Objects purged and reingested again, its source data (generated and enriched with UUIDS) CSV replaced, improved and uploaded again and ingested.

??? info "Click to read the full AMI 0.1.0 (Archipelago - 1.0.0-RC2) Pre-Release Notes."

    #### Setup Steps
    
    AMI has Ingest, Update and Patch capabilities. AMI has a plugin system to fetch data. The data can come from multiple sources and right now (RC2) CSV/EXCEL or Google Spreadsheets are the ones enabled. Direct from Solr/OAI/API is on the works too for RC3. AMI can read files locally from the server, remotely from URLs or remotely from Private Backend Storage (S3). It does parent/children validation, makes sure that parents are ingested first, cleans broken relationships, allows arbitrary multi relations to be generated in a single ROW (ismemberof, partOf, etc)  pointing to other rows or existing ADOs (via UUIDs) and can process rows directly as JSON or preprocessed via a Metadata Display entity (twig template) capable of producing JSON output. These templates can be configured by “type”, Articles v/s 3DModel can have different ones. Even which columns contain Files can be configured at that level.
    
    #### AMI Set Entity
    
    Ami Sets are special custom entities that hold an Ingest Strategy generated via the previous Setup steps (as JSON with all it's settings), a CSV with data imported from the original source (with UUIDs prepopulated if they were not provided by the user). These AMI sets are simpler and faster than “batch sets” because they do not have a single entry per Object to be ingested. All data lives in a CSV. This means the CSV of an AMI set can be corrected and reuploaded. Users can then Process a Set either putting the to be ingested ADOs in the queue and let Hydroponics Service do the rest or directly via Batch on the UI. ADOs generated by a set can also be purged from there. These sets can also be created manually if needed of any of the chosen settings modified anytime. Which AMI set generated the Ingest is also tracked in a newly created ADO’s JSON and any other extra data (or fixed data e.g common Rights statements, or LoD) can be provided by a Twig Template. Ingest is amazingly fast. We monitored Ingest with Remote URL(islandora Datastreams) files of 15Mbytes average at a speed of 2 seconds per Object (including all post processing) continuously for a set of 100+.
    
    #### Search and Replace
    
    This module also provides a simple search/replace text VBO action (handles JSON as text) and a full blown JSONPATCH VBO action to batch modify ADOs. The last one is extremely powerful permitting multiple operations at the same time with tests. E.g replace a certain value, add another value, remove another value only if a certain test (e.g “type”:”Article” and “date_of_digital”: “2020-09-09”) matches. If any tests fail the whole operation will be canceled for that ADO. An incomplete “Webform” VBO action is present but not fully functional yet. This one allows you to choose a Webform, a certain element inside that Webform and then find and replace using the same Interface you would see while editing/adding a new ADO via the web form workflow. Should be ready by RC3.


## Getting started with AMI

You can access AMI through the `AMI Sets` tab on the main Content page found at `/admin/content` or directly at `/amiset/list`.

  ![AMI Sets List](images/ami/AMIsetsList.jpg)

## Google Sheets API Congifuration

If you plan on using the Google Sheets Importer option, you will need to [Configure the Google Sheets API](googleapi.md).

## Spreadsheet Formatting Overview

There are multiple ways a spreadsheet/CSV file can be structured to work with AMI, depending on the data transformation and mapping you will be using.


??? info "Click to view Basic Requirements and Recommended Options"

    - For most standard AMI ingests, each Row of your spreadsheet/CSV will correspond to a single Digital Object or Collection.
    - Columns in your spreadsheet/CSV can be mapped to different data (files) and metadata elements (label, description, subjects, etc.).
    
    - It is recommended that different types of files are placed into separate columns--"images", "documents", "models", "videos", "audios", "text".
        - Filepaths can point to remote files, to existing files within your docker container, s3 (or other storage type/location that is accessible to Archipelago), and to paths within zip files.
            - Example path for existing file within docker container:
              `/var/www/html/d8content/myAMIimage.jpg`
            - Example s3 path:
              `s3://myAMIuploads/myAMIdocument.pdf`
            - Example remote filepath:
              `https://dogsaregreat.edu/dogs.tiff`
        - **Multiple files (of the same type) can be placed in a single cell, separated by a semicolon ( ; ).
        - For Digital Objects comprised of multiple types of files, such as an Oral History Interview with an audio file and a PDF transcript file, you can place different file types within different corresponding columns for the same Row.
        - It is recommended that filepaths are copied/stored as plain (non hyperlinked) formatted text.
    
    - **Every spreadsheet/CSV file should contain the following Columns:**
        - `type`
            - the Digital Object or Digital Object Collection Type, such as 'Photograph' or 'Collection'
        - `label`
            - the title of the Digital Object or Collection
        - **Soft-requirement* `node_uuid`
            - this can be empty
            - if empty, Archipelago will automatically generate UUIDs
            - can be used with existing UUIDs during migrations
    
    - **Recommended Columns:**
        - Files as defined above
            - "images", "documents", "models", "videos", "audios", "text"
            - .warc/.wacz files should be placed in a column "upload_associated_warcs"
        - `ismemberof` and/or `ispartof` (and/or whatever predicate corresponds with the relationship you are mapping)
            - these columns can be used to connect related objects using the object-to-object relationship that matches your needs
            - these columns can hold 3 types of values
                - empty (no value)
                - an integer to connect an object to another object's corresponding row in the same spreadsheet/CSV
                    - Ex: Row 2 corresponds to a Digital Object Collection; for a Digital Object corresponding to Row 3, the 'ismemberof' column contains a value of '2'. The Digital Object in Row 3 would be ingested as a member of the Digital Object Collection in Row 2.
                - a UUID to connect with an already ingested object
        - Metadata—for all the rich, detailed information associated with your Digital Objects and Collections
            - Every Column header will become a JSON Key and each cell a JSON value for that Key
            - You can use direct JSON snippets such as:
 
              ````json
              [{"uri": "http://id.loc.gov/authorities/subjects/sh95008857","label": "Digital libraries"}]
              ````
 
            - If you have an advanced twig template with the necessary logic, you can place data in cells that can be parsed and structured in various ways (such as multiple values separated by semicolons split accordingly, capitalization of values based on defined patterns, etc.)


### Example Spreadsheet/CSV

This spreadsheet can be used to import a small set of Digital Objects using the same assets part of the [Two-Step Demo content ingest guide](democontent.md) (these objects can also be found in the [Archipelago Deployment repository](https://github.com/esmero/archipelago-deployment)).

- <https://docs.google.com/spreadsheets/d/10IAgDZ1_fGVd_2g1GyUYs0SrnkAfvVtTwukEaIEny5Y/edit?usp=sharing>
- To use this spreadsheet, you can either download as a CSV file to use with the Spreadsheet Importer, or make a copy of this using your [configured Google Sheets API account](googleapi.md).

### Example JSON template

This JSON template can be used during the Data Transformation (step 3) of your AMI Import. This particular template corresponds with the metadata elements found in the Default Descriptive Metadata and Default Digital Object Collection webforms shipped with Archipelago 1.0.0-RC2.

??? info "Click to view the example 1.0.0-RC2 AMI JSON template"
    
    To use this template, copy and paste the JSON below directly into a new Metadata Display, found here for a local `http://localhost:8001/metadatadisplay/list` or `http://yoursite.org/metadatadisplay/list`. Select `JSON` as the 'Primary mime type this Twig Template entity will generate as output' for this new Metadata Display.
    
    ```json_encode
      {
          "type": {{ data.type|json_encode|raw }},
          "label": {{ data.label|json_encode|raw }},
          "issue_number": {{ data.issue_number|json_encode|raw }},
          "interviewee": {{ data.interviewee|json_encode|raw }},
          "interviewer": {{ data.interviewer|json_encode|raw }},
          "duration": {{ data.duration|json_encode|raw }},
          "website_url": {{ data.website_url|json_encode|raw }},
          "description": {{ data.description|json_encode|raw }},
          "date_created": {{ data.date_created|json_encode|raw }},
          "creator": {{ data.creator|json_encode|raw }},
          "creator_lod": {{ data.creator_lod|json_encode|raw }},
          "publisher": {{ data.publisher|json_encode|raw }},
          "language": {{ data.language|json_encode|raw }},
          "ismemberof": [],
          "owner": {{ data.owner|json_encode|raw }},
          "local_identifier": {{ data.local_identifier|json_encode|raw }},
          "date_published": {{ data.date_published|json_encode|raw }},
          "rights_statements": {{ data.rights_statements|json_encode|raw }},
          "rights": {{ data.rights|json_encode|raw }},
          "subject_loc": {{ data.subject_loc|json_encode|raw }},
          "subject_lcnaf_personal_names": {{ data.subject_lcnaf_personal_names|json_encode|raw }},
          "subject_lcnaf_corporate_names": {{ data.subject_lcnaf_corporate_names|json_encode|raw }},
          "subject_lcnaf_geographic_names": {{ data.subject_lcnaf_geographic_names|json_encode|raw }},
          "subject_lcgft_terms": {{ data.subject_lcgft_terms|json_encode|raw }},
          "subject_wikidata": {{ data.subject_wikidata|json_encode|raw }},
          "edm_agent": {{ data.edm_agent|json_encode|raw }},
          "term_aat_getty": {{ data.term_aat_getty|json_encode|raw }},
          "geographic_location": {{ data.geographic_location|json_encode|raw }},
          "subjects_local_personal_names": {{ data.subjects_local_personal_names|json_encode|raw }},
          "subjects_local": {{ data.subjects_locals|json_encode|raw }},
          "audios": [],
          "images": [],
          "models": [],
          "videos": [],
          "documents": [],
          "as:generator": {
              "type": "Create",
              "actor": {
                  "url": {{ setURL|json_encode|raw }},
                  "name": "ami",
                  "type": "Service"
              },
              "endTime": "{{"now"|date("c")}}",
              "summary": "Generator",
              "@context": "https:\/\/www.w3.org\/ns\/activitystreams"
          },
          "upload_associated_warcs": []
      }
    ```

---

Thank you for reading! Please contact us on our [Archipelago Commons Google Group](https://groups.google.com/forum/#!forum/archipelago-commons) with any questions or feedback.

Return to the [Archipelago Documentation main page](index.md).
